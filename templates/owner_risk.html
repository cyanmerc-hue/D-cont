<!DOCTYPE html>
<html>
<head>
    <title>Owner Risk - D-cont</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css', v=asset_version) }}">
</head>
<body class="app-body">
    <div class="app-header">
        <img src="/static/logo.png" onerror="this.onerror=null;this.src='/static/logo.svg';" alt="D-cont Logo" class="app-logo"/>
    </div>

    {% include '_owner_nav.html' %}

    <div class="container container-wide" style="margin: 18px auto 48px auto;">
      <div class="card" style="padding:24px;">
        <div style="display:flex; justify-content: space-between; align-items:center; gap: 12px;">
            <h2 class="pageTitle">Risk / Defaults</h2>
            <a href="/logout" class="btn btn-sm" style="width:auto; padding:6px 16px; border-radius:6px;">Logout</a>
        </div>

                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        <div class="notice" style="margin-top:12px; padding:10px 12px;">
                            {{ messages[0] }}
                        </div>
                    {% endif %}
                {% endwith %}

        <div class="notice" style="margin-top:14px;">
            <div style="font-weight:800;">Purpose</div>
            <div class="muted" style="margin-top:6px;">Protect the platform. This view summarizes accounts that are blocked/frozen/low trust.</div>
        </div>

                <h3 class="sectionTitle">Early payout requests</h3>
                {% if early_payout_requests and early_payout_requests|length > 0 %}
                    <div style="margin-top:10px; overflow-x:auto;">
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left; padding:8px 6px;" class="muted">User</th>
                                    <th style="text-align:left; padding:8px 6px;" class="muted">Group</th>
                                    <th style="text-align:left; padding:8px 6px;" class="muted">Monthly</th>
                                    <th style="text-align:left; padding:8px 6px;" class="muted">Deposit</th>
                                    <th style="text-align:left; padding:8px 6px;" class="muted">Status</th>
                                    <th style="text-align:left; padding:8px 6px;" class="muted">Deposit status</th>
                                    <th style="text-align:left; padding:8px 6px;" class="muted">UTR</th>
                                    <th style="text-align:left; padding:8px 6px;" class="muted">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for r in early_payout_requests %}
                                <tr style="border-top:1px solid rgba(255,255,255,0.08);">
                                    <td style="padding:10px 6px;">
                                        <div style="font-weight:700;">{{ r.full_name or r.username }}</div>
                                        <div class="muted" style="font-size:0.9em;">{{ r.mobile }}</div>
                                        <div class="muted" style="font-size:0.85em;">{{ r.created_at }}</div>
                                    </td>
                                    <td style="padding:10px 6px;">{{ r.group_name or ('#' ~ r.group_id) }}</td>
                                    <td style="padding:10px 6px;">₹{{ r.monthly_amount }}</td>
                                    <td style="padding:10px 6px;">₹{{ r.deposit_amount }}</td>
                                    <td style="padding:10px 6px;">{{ r.status }}</td>
                                    <td style="padding:10px 6px;">{{ r.deposit_status }}</td>
                                    <td style="padding:10px 6px;">{{ r.utr }}</td>
                                    <td style="padding:10px 6px; min-width:300px;">
                                        <form method="POST" action="/owner/early-payout/{{ r.id }}/verify-deposit" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                                            <input class="input" name="utr" value="{{ r.utr }}" placeholder="UTR/reference" style="margin:0; min-width: 140px;" />
                                            <button class="btn btn-secondary" type="submit" style="width:auto; padding:6px 10px;">Verify deposit</button>
                                        </form>
                                        <form method="POST" action="/owner/early-payout/{{ r.id }}/decision" style="display:flex; gap:8px; align-items:center;">
                                            <input class="input" name="reason" placeholder="Reason (optional)" style="margin:0; min-width: 160px;" />
                                            <button class="btn" type="submit" name="action" value="approve" style="width:auto; padding:6px 10px;">Approve</button>
                                            <button class="btn btn-secondary" type="submit" name="action" value="reject" style="width:auto; padding:6px 10px;">Reject</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="muted">None.</div>
                {% endif %}

        <h3 class="sectionTitle">Blocked accounts</h3>
        {% if blocked and blocked|length > 0 %}
            <ul>
                {% for u in blocked %}
                    <li>{{ u.full_name or u.username }} ({{ u.mobile }})</li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="muted">None.</div>
        {% endif %}

        <h3 class="sectionTitle">Future frozen</h3>
        {% if frozen and frozen|length > 0 %}
            <ul>
                {% for u in frozen %}
                    <li>{{ u.full_name or u.username }} ({{ u.mobile }})</li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="muted">None.</div>
        {% endif %}

        <h3 class="sectionTitle">Low trust (&lt; 40)</h3>
        {% if low_trust and low_trust|length > 0 %}
            <ul>
                {% for u in low_trust %}
                    <li>{{ u.full_name or u.username }} ({{ u.mobile }}) — trust {{ u.trust_score }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="muted">None.</div>
        {% endif %}

        <div class="muted" style="margin-top:18px; font-size:0.95em;">Missed payments / UTR mismatches require contribution logs to be enabled.</div>
            </div>
        </div>
</body>
</html>
