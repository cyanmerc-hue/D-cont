<!DOCTYPE html>
<html>
<head>
    <title>Owner User - D-cont</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css', v=asset_version) }}">
</head>
<body class="app-body">
    {% include '_owner_nav.html' %}

    <div class="container container-wide" style="margin: 18px auto 48px auto;">
      <div class="card" style="padding:24px; color:#222;">
        <div style="display:flex; justify-content: space-between; align-items:center; gap: 12px;">
            <div>
                <a href="/owner/users" style="color:#2D9CDB; text-decoration:none;">← Back to Users</a>
                <h2 style="margin:8px 0 0 0; color:#2D9CDB;">{{ user.full_name or user.username }}</h2>
                <div style="color:#777; font-size:0.95em;">{{ user.username }}</div>
            </div>
            <a href="/logout" class="btn btn-sm" style="width:auto; padding:6px 16px; border-radius:6px;">Logout</a>
        </div>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
                        <div class="notice" style="margin-top:12px; padding:10px 12px;">
              {{ messages[0] }}
            </div>
          {% endif %}
        {% endwith %}

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; margin-top:18px;">
            <div style="border:1px solid #e8eef0; border-radius:10px; padding:14px;">
                <div style="color:#555;">Phone</div>
                <div style="font-weight:700;">{{ user.mobile }}</div>
            </div>
            <div style="border:1px solid #e8eef0; border-radius:10px; padding:14px;">
                <div style="color:#555;">Trust score</div>
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                    <div style="font-weight:700;">{{ user.trust_score }} • {{ user.trust_score|trust_band }}</div>
                    <span class="{{ user.trust_score|trust_badge_class }}">{{ user.trust_score|trust_band }}</span>
                </div>
            </div>
            <div style="border:1px solid #e8eef0; border-radius:10px; padding:14px;">
                <div style="color:#555;">App fee paid</div>
                <div style="font-weight:700;">{{ 'Yes' if user.app_fee_paid else 'No' }}</div>
            </div>
            <div style="border:1px solid #e8eef0; border-radius:10px; padding:14px;">
                <div style="color:#555;">Future groups</div>
                <div style="font-weight:700;">{{ 'Frozen' if user.join_blocked else 'Allowed' }}</div>
            </div>
        </div>

        <div style="margin-top:14px; border:1px solid #e8eef0; border-radius:10px; padding:14px;">
            <div style="font-weight:700; color:#222;">Trust score breakdown</div>
            <div style="margin-top:10px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
                <div style="border:1px solid #eef3f5; border-radius:10px; padding:12px;">
                    <div style="color:#777; font-size:0.95em;">On-time verified</div>
                    <div style="font-weight:800;">{{ trust_breakdown.on_time_verified or 0 }}</div>
                </div>
                <div style="border:1px solid #eef3f5; border-radius:10px; padding:12px;">
                    <div style="color:#777; font-size:0.95em;">Late verified</div>
                    <div style="font-weight:800;">{{ trust_breakdown.late_verified or 0 }}</div>
                </div>
                <div style="border:1px solid #eef3f5; border-radius:10px; padding:12px;">
                    <div style="color:#777; font-size:0.95em;">Missed</div>
                    <div style="font-weight:800;">{{ trust_breakdown.missed or 0 }}</div>
                </div>
                <div style="border:1px solid #eef3f5; border-radius:10px; padding:12px;">
                    <div style="color:#777; font-size:0.95em;">Rejected UTR</div>
                    <div style="font-weight:800;">{{ trust_breakdown.rejected or 0 }}</div>
                </div>
                <div style="border:1px solid #eef3f5; border-radius:10px; padding:12px;">
                    <div style="color:#777; font-size:0.95em;">Completed groups</div>
                    <div style="font-weight:800;">{{ trust_breakdown.completed_groups or 0 }}</div>
                </div>
                <div style="border:1px solid #eef3f5; border-radius:10px; padding:12px;">
                    <div style="color:#777; font-size:0.95em;">Deposit verified</div>
                    <div style="font-weight:800;">{{ trust_breakdown.deposit_verified or 0 }}</div>
                </div>
                <div style="border:1px solid #eef3f5; border-radius:10px; padding:12px;">
                    <div style="color:#777; font-size:0.95em;">Default after payout</div>
                    <div style="font-weight:800;">{{ trust_breakdown.default_after_payout or 0 }}</div>
                </div>
            </div>
            <div style="margin-top:10px; color:#777; font-size:0.95em;">Grace window: {{ trust_breakdown.grace_days or 2 }} day(s).</div>
        </div>

        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <form method="post" action="/owner/users/verify_app_fee" style="margin:0;">
                <input type="hidden" name="username" value="{{ user.username }}">
                <button type="submit" style="background:#16a34a; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Verify App Fee (This Month)</button>
            </form>

            <form method="post" action="/admin/toggle_user_active" style="margin:0;">
                <input type="hidden" name="username" value="{{ user.username }}">
                <input type="hidden" name="action" value="{{ 'block' if user.is_active else 'unblock' }}">
                <button type="submit" style="background:#2D9CDB; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">{{ 'Block' if user.is_active else 'Unblock' }}</button>
            </form>

            <form method="post" action="/owner/users/toggle_join_block" style="margin:0;">
                <input type="hidden" name="username" value="{{ user.username }}">
                <button type="submit" style="background:#fff; color:#b42318; border:1px solid #b42318; padding:8px 12px; border-radius:8px; cursor:pointer;">{{ 'Unfreeze future' if user.join_blocked else 'Freeze future' }}</button>
            </form>
        </div>

        <div style="margin-top:14px; border:1px solid #e8eef0; border-radius:10px; padding:14px;">
            <div style="font-weight:700; color:#222;">Reset password (Owner only)</div>
            <form method="post" action="/owner/users/reset_password" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <input type="hidden" name="username" value="{{ user.username }}">
                <input name="new_password" type="password" placeholder="New password (min 6 chars)" class="input" style="margin:0; max-width: 320px;" />
                <button type="submit" class="btn btn-sm" style="width:auto; padding:8px 14px;">Reset</button>
            </form>
            <div style="margin-top:8px; color:#777; font-size:0.95em;">Use this if the user forgot their password or is stuck due to legacy/blank password data.</div>
        </div>

        <div style="margin-top:14px; border:1px solid #e8eef0; border-radius:10px; padding:14px;">
            <div style="font-weight:700; color:#222;">Record trust event (auto updates score)</div>
            <form method="post" action="/owner/users/add_trust_event" style="margin-top:10px; display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
                <input type="hidden" name="username" value="{{ user.username }}">

                <div>
                    <div style="color:#555; font-size:0.95em;">Event</div>
                    <select name="event_type" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cfd8dc;">
                        <option value="contribution_verified">Verified contribution</option>
                        <option value="contribution_rejected">Rejected/duplicate UTR</option>
                        <option value="payment_missed">Missed payment</option>
                        <option value="default_after_payout">Default after payout</option>
                        <option value="deposit_verified">Deposit verified</option>
                        <option value="group_completed">Group cycle completed</option>
                    </select>
                </div>

                <div>
                    <div style="color:#555; font-size:0.95em;">Due date (YYYY-MM-DD)</div>
                    <input name="due_date" type="text" placeholder="2025-12-05" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cfd8dc;" />
                </div>

                <div>
                    <div style="color:#555; font-size:0.95em;">Verified date (YYYY-MM-DD)</div>
                    <input name="verified_at" type="text" placeholder="{{ (trust_events[0].created_at if trust_events and trust_events|length>0 else '') }}" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cfd8dc;" />
                </div>

                <div>
                    <div style="color:#555; font-size:0.95em;">Group ID (optional)</div>
                    <input name="group_id" type="text" placeholder="" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cfd8dc;" />
                </div>

                <div style="grid-column: 1 / -1;">
                    <div style="color:#555; font-size:0.95em;">Note (optional)</div>
                    <input name="note" type="text" placeholder="e.g., UTR verified by receiver" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cfd8dc;" />
                </div>

                <div style="grid-column: 1 / -1;">
                    <button type="submit" style="background:#2D9CDB; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;">Add event</button>
                </div>
            </form>
            <div style="margin-top:8px; color:#777; font-size:0.95em;">For “Verified contribution”, due date is required. Late/missed is calculated using the grace window.</div>
        </div>

        <h3 style="margin-top:22px;">Trust history</h3>
        {% if trust_events and trust_events|length > 0 %}
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse: collapse; min-width: 760px;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Type</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Due</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Verified</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Group</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Note</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for e in trust_events %}
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid #f2f2f2;">{{ e.type }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f2f2f2;">{{ e.due_date }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f2f2f2;">{{ e.verified_at }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f2f2f2;">{{ e.group_id }}</td>
                            <td style="padding:8px; border-bottom:1px solid #f2f2f2;">{{ e.note }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div style="color:#777;">No trust events recorded yet.</div>
        {% endif %}

        <h3 style="margin-top:22px;">Groups</h3>
        {% if groups and groups|length > 0 %}
            <ul style="list-style:none; padding:0; margin:0;">
                {% for g in groups %}
                    <li style="margin-bottom:10px; border:1px solid #e8eef0; border-radius:10px; padding:12px;">
                        <div style="font-weight:700; color:#2D9CDB;">{{ g.name }}</div>
                        <div style="color:#222;"><strong>₹{{ g.monthly_amount }}</strong> / month</div>
                        <div style="color:#555; margin-top:4px;"><strong>Status:</strong> {{ g.status }}</div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div style="color:#777;">No joined groups.</div>
        {% endif %}
      </div>
    </div>
</body>
</html>
