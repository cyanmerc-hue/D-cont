<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Groups - D-cont</title>
  <meta name="theme-color" content="#05060A">
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css', v=asset_version) }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json', v=asset_version) }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png', v=asset_version) }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png', v=asset_version) }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png', v=asset_version) }}">
</head>
<body class="app-body hasTabs">
  {% include '_tab_nav.html' %}

  <div class="container">
    <div class="card">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="notice" style="margin-bottom:12px; padding:10px 12px;">
          {{ messages[0] }}
        </div>
      {% endif %}
    {% endwith %}

    <h2 style="margin:0;">Available Groups</h2>
    <div class="muted" style="margin-top:6px; line-height:1.45;">Choose a group created by D-CONT. Join with one tap.</div>

    <form method="get" action="/groups" style="margin-top:14px; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
      <div>
        <div class="muted small" style="margin-bottom:6px;">Filter by Monthly Amount</div>
        <select class="input" name="amount" style="margin:0; width:200px; padding:12px 12px;">
          <option value="" {% if not amount_filter %}selected{% endif %}>All amounts</option>
        {% for a in allowed_amounts %}
          <option value="{{ a }}" {% if amount_filter == (a|string) %}selected{% endif %}>₹{{ a }}</option>
        {% endfor %}
        </select>
      </div>

      <div>
        <div class="muted small" style="margin-bottom:6px;">Filter by Status</div>
        <select class="input" name="status" style="margin:0; width:220px; padding:12px 12px;">
          <option value="" {% if not status_filter %}selected{% endif %}>All statuses</option>
          <option value="open" {% if status_filter=='open' %}selected{% endif %}>Open to Join</option>
          <option value="formation" {% if status_filter=='formation' %}selected{% endif %}>Formation (Not Started)</option>
          <option value="active" {% if status_filter=='active' %}selected{% endif %}>Active (Running)</option>
          <option value="full" {% if status_filter=='full' %}selected{% endif %}>Full</option>
        </select>
      </div>

      <button type="submit" class="btn btn-secondary btn-sm" style="width:auto; padding:8px 12px;">Apply</button>
    </form>

    {% if available_groups and available_groups|length > 0 %}
      <ul style="list-style:none; padding:0; margin:14px 0 0 0;">
        {% for g in available_groups %}
          <li class="card-pro" style="margin-bottom:12px; padding:14px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
              <div style="min-width:0;">
                <div style="font-weight:900;">₹{{ g.monthly_amount }} Savings Circle • {{ g.max_members }} Members • Monthly</div>
                <div class="muted" style="margin-top:6px; font-size:0.95em; line-height:1.45;">
                  Joining:
                  {% if g.status_filter == 'open' %}Open{% elif g.status_filter == 'full' %}Full{% elif g.status_filter == 'active' %}Active (Running){% else %}Closed{% endif %}
                  <br>
                  Members: {{ g.joined_members }}/{{ g.max_members }}
                  <br>
                  Starts: {{ g.starts_label }}
                  <br>
                  Duration: {{ g.duration_months }} months
                </div>
                {% if g.description %}<div class="muted" style="margin-top:6px; line-height:1.45;">{{ g.description }}</div>{% endif %}
              </div>

              <div style="min-width:140px; text-align:right;">
                {% if g.status_filter == 'open' %}
                  <form method="POST" action="/groups/join" style="margin:0;">
                    <input type="hidden" name="group_id" value="{{ g.id }}" />
                    <button type="submit" class="btn btn-sm" style="width:auto;">Join Group</button>
                  </form>
                {% elif g.status_filter == 'full' %}
                  <button class="btn btn-secondary btn-sm" disabled style="width:auto; opacity:.7;">Group Full</button>
                {% else %}
                  <button class="btn btn-secondary btn-sm" disabled style="width:auto; opacity:.7;">Joining Closed</button>
                {% endif %}
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="notice" style="margin-top:14px;">No groups found for the selected filters.</div>
    {% endif %}
    </div>
  </div>

</body>
</html>
