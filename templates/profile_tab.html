<!DOCTYPE html>
<html>
<head>
  <title>Profile - D-cont</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#05060A">
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css', v=asset_version) }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json', v=asset_version) }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png', v=asset_version) }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png', v=asset_version) }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png', v=asset_version) }}">
</head>
<body class="app-body hasTabs">
  {% include '_tab_nav.html' %}

  <div class="container">
    <div class="card">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="notice" style="margin-bottom:12px; padding:10px 12px;">
          {{ messages[0] }}
        </div>
      {% endif %}
    {% endwith %}

    <h2 style="margin:0;">{{ t('profile_title') }}</h2>

    <div class="card-pro" style="margin-top:12px; padding:14px;">
      <div class="muted" style="font-size:0.95em;">{{ t('profile_app_fee_paid') }}</div>
      <div style="font-size:18px; font-weight:bold;">{{ t('yes') if app_fee_paid else t('no') }}</div>
    </div>

    <div class="card-pro" style="margin-top:12px; padding:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <div class="muted" style="font-size:0.95em;">{{ t('trust_score_label') }}</div>
          <div style="font-size:18px; font-weight:bold;">{{ trust_score }} • {{ trust_score|trust_band }}</div>
        </div>
        <span class="{{ trust_score|trust_badge_class }}">{{ trust_score|trust_band }}</span>
      </div>
      <div class="muted" style="font-size:0.95em; margin-top:6px;">{{ t('benefit_trust_grows_body') }}</div>
      <div class="muted" style="font-size:0.95em; margin-top:6px;">{{ t('benefit_control_body') }}</div>
    </div>

    <div class="card-pro" style="margin-top:12px; padding:14px;">
      <div class="sectionTitle" style="margin-top:0;">{{ t('profile_quick_login_title') }}</div>
      <div class="muted" style="margin-top:6px; line-height:1.45;">{{ t('profile_fingerprint_note') }}</div>

      <div class="sectionTitle" style="margin-top:14px;">{{ t('profile_mpin_title') }}</div>
      <form method="POST" action="/profile/mpin" style="margin-top:8px;">
        <label class="muted" style="display:block; font-size:0.95em;">{{ t('profile_mpin_current_password') }}</label>
        <input name="current_password" type="password" class="input" autocomplete="current-password" />

        <div class="row" style="margin-top:6px;">
          <div class="col" style="min-width:220px;">
            <label class="muted" style="display:block; font-size:0.95em;">{{ t('profile_mpin_new') }}</label>
            <input name="new_mpin" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="input" autocomplete="off" />
          </div>
          <div class="col" style="min-width:220px;">
            <label class="muted" style="display:block; font-size:0.95em;">{{ t('profile_mpin_confirm') }}</label>
            <input name="confirm_mpin" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="input" autocomplete="off" />
          </div>
        </div>
        <button type="submit" class="btn" style="margin-top:10px;">{{ t('profile_mpin_save') }}</button>
      </form>

      {% if mpin_enabled %}
        <form method="POST" action="/profile/mpin/disable" style="margin-top:10px;">
          <label class="muted" style="display:block; font-size:0.95em;">{{ t('profile_mpin_current_password') }}</label>
          <input name="current_password" type="password" class="input" autocomplete="current-password" />
          <button type="submit" class="btn btn-secondary btn-sm" style="width:auto;">{{ t('profile_mpin_disable') }}</button>
        </form>
      {% endif %}

      <div class="sectionTitle" style="margin-top:14px;">{{ t('profile_fingerprint_title') }}</div>
      {% if fingerprint_enabled %}
        <div class="muted" style="margin-top:6px;">{{ t('profile_fingerprint_enabled') }}</div>

        <form method="POST" action="/profile/fingerprint/disable" style="margin-top:10px;">
          <label class="muted" style="display:block; font-size:0.95em;">{{ t('profile_mpin_current_password') }}</label>
          <input name="current_password" type="password" class="input" autocomplete="current-password" />
          <button type="submit" class="btn btn-secondary btn-sm" style="width:auto;">{{ t('profile_fingerprint_disable') }}</button>
        </form>
      {% else %}
        <button type="button" class="btn btnGhost" id="enableFingerprintBtn" style="margin-top:10px;">{{ t('profile_fingerprint_enable') }}</button>
        <div class="muted small" id="fingerprintSetupStatus" style="margin-top:8px;"></div>
      {% endif %}
    </div>

    <div class="card-pro" id="referral" style="margin-top:14px; padding:14px;">
      <div class="sectionTitle" style="margin-top:0;">{{ t('referral_card_title') }}</div>
      <div class="muted" style="margin-top:6px; line-height:1.45;">{{ t('referral_card_body') }}</div>
      <div class="muted" style="margin-top:8px; line-height:1.45;">{{ t('referral_credit_disclaimer') }}</div>

      <div class="notice" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>

          <script>
            (function() {
              const btn = document.getElementById('enableFingerprintBtn');
              const statusEl = document.getElementById('fingerprintSetupStatus');
              if (!btn) return;

              function base64urlToBuffer(base64url) {
                const base64 = (base64url || '').replace(/-/g, '+').replace(/_/g, '/');
                const pad = '='.repeat((4 - (base64.length % 4)) % 4);
                const binary = atob(base64 + pad);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                return bytes.buffer;
              }

              function bufferToBase64url(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
                const base64 = btoa(binary);
                return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
              }

              async function enableFingerprint() {
                statusEl.textContent = '';
                if (!window.PublicKeyCredential || !navigator.credentials) {
                  statusEl.textContent = 'Fingerprint login is not supported on this browser.';
                  return;
                }
                if (!window.isSecureContext) {
                  statusEl.textContent = 'Fingerprint login requires HTTPS. Please open the site in a secure (https) connection.';
                  return;
                }
                try {
                  statusEl.textContent = 'Opening fingerprint setup...';
                  const resp = await fetch('/auth/webauthn/register/options', {
                    credentials: 'same-origin',
                    headers: { 'Accept': 'application/json' },
                  });

                  if (resp.redirected || (resp.url && resp.url.includes('/login'))) {
                    statusEl.textContent = 'Session expired. Please login again.';
                    window.location.href = '/login';
                    return;
                  }

                  const ct = (resp.headers.get('content-type') || '').toLowerCase();
                  let options = null;
                  if (ct.includes('application/json')) {
                    options = await resp.json();
                  } else {
                    const text = await resp.text();
                    if (resp.status === 401 || (text || '').toLowerCase().includes('<!doctype') || (text || '').toLowerCase().includes('<html')) {
                      statusEl.textContent = 'Session expired. Please login again.';
                      window.location.href = '/login';
                      return;
                    }
                    statusEl.textContent = resp.status >= 500
                      ? `Unable to start fingerprint setup (server error ${resp.status}). Please try again.`
                      : `Unable to start fingerprint setup (HTTP ${resp.status}). Please try again.`;
                    return;
                  }
                  if (!resp.ok) {
                    statusEl.textContent = options.error || 'Unable to start fingerprint setup.';
                    return;
                  }

                  options.challenge = base64urlToBuffer(options.challenge);
                  options.user.id = base64urlToBuffer(options.user.id);
                  if (Array.isArray(options.excludeCredentials)) {
                    options.excludeCredentials = options.excludeCredentials.map((c) => ({
                      ...c,
                      id: base64urlToBuffer(c.id),
                    }));
                  }

                  const attestation = await navigator.credentials.create({ publicKey: options });
                  const credential = {
                    id: attestation.id,
                    rawId: bufferToBase64url(attestation.rawId),
                    type: attestation.type,
                    response: {
                      clientDataJSON: bufferToBase64url(attestation.response.clientDataJSON),
                      attestationObject: bufferToBase64url(attestation.response.attestationObject),
                    },
                  };

                  const verifyResp = await fetch('/auth/webauthn/register/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(credential),
                  });

                  if (verifyResp.redirected || (verifyResp.url && verifyResp.url.includes('/login'))) {
                    statusEl.textContent = 'Session expired. Please login again.';
                    window.location.href = '/login';
                    return;
                  }
                  const verifyCt = (verifyResp.headers.get('content-type') || '').toLowerCase();
                  let verifyJson = null;
                  if (verifyCt.includes('application/json')) {
                    verifyJson = await verifyResp.json();
                  } else {
                    const text = await verifyResp.text();
                    if (verifyResp.status === 401 || (text || '').toLowerCase().includes('<!doctype') || (text || '').toLowerCase().includes('<html')) {
                      statusEl.textContent = 'Session expired. Please login again.';
                      window.location.href = '/login';
                      return;
                    }
                    statusEl.textContent = verifyResp.status >= 500
                      ? `Fingerprint setup failed (server error ${verifyResp.status}). Please try again.`
                      : `Fingerprint setup failed (HTTP ${verifyResp.status}). Please try again.`;
                    return;
                  }
                  if (!verifyResp.ok || !verifyJson.ok) {
                    statusEl.textContent = verifyJson.error || 'Fingerprint setup failed.';
                    return;
                  }

                  statusEl.textContent = 'Fingerprint login enabled.';
                  window.location.reload();
                } catch (e) {
                  const name = (e && (e.name || e.constructor && e.constructor.name)) ? (e.name || e.constructor.name) : 'Error';
                  const msg = (e && e.message) ? e.message : '';
                  if (name === 'NotAllowedError') {
                    statusEl.textContent = 'Fingerprint setup was cancelled or not allowed. Please try again and confirm the system prompt.';
                    return;
                  }
                  if (name === 'NotSupportedError') {
                    statusEl.textContent = 'Fingerprint setup is not supported on this device/browser.';
                    return;
                  }
                  if (name === 'SecurityError') {
                    statusEl.textContent = 'Fingerprint setup blocked for security reasons (usually HTTPS/origin mismatch). Please re-open the site and try again.';
                    return;
                  }
                  statusEl.textContent = msg ? `Fingerprint setup failed (${name}): ${msg}` : `Fingerprint setup failed (${name}).`;
                }
              }

              btn.addEventListener('click', enableFingerprint);
            })();
          </script>
            <div class="muted" style="font-size:0.95em;">{{ t('referral_your_code') }}</div>
            <div style="font-size:18px; font-weight:800; letter-spacing:0.5px;">{{ referral_code or '' }}</div>
          </div>
          <button type="button" class="btn btn-secondary" style="width:auto;" onclick="shareReferral()">{{ t('referral_share') }}</button>
        </div>
        <div class="muted" style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div><strong>{{ t('referral_app_fee_credit_balance') }}</strong> ₹{{ app_fee_credit_balance or 0 }}</div>
          <div><strong>{{ t('referral_total_rewards') }}</strong> ₹{{ total_rewards_earned or 0 }}</div>
        </div>
      </div>

      <div class="sectionTitle" style="margin-top:14px;">{{ t('referral_list_title') }}</div>
      {% if referrals and referrals|length > 0 %}
        {% for r in referrals %}
          <div class="card-pro" style="padding:12px; margin-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
              <div>
                <div style="font-weight:800;">{{ r.new_full_name or r.new_username }}</div>
                <div class="muted" style="margin-top:6px; font-size:0.95em;">
                  {% if r.joined_group %}
                    {{ t('referral_stage_joined_group') }}
                  {% else %}
                    {{ t('referral_stage_not_joined') }}
                  {% endif %}
                  •
                  {% if r.app_fee_paid %}
                    {{ t('referral_stage_fee_paid') }}
                  {% else %}
                    {{ t('referral_stage_fee_pending') }}
                  {% endif %}
                </div>
              </div>
              <div class="muted" style="font-size:0.95em; text-align:right;">
                {% if r.status == 'CREDITED' %}
                  <strong>{{ t('referral_status_credited') }}</strong>
                {% elif r.status == 'ELIGIBLE' %}
                  <strong>{{ t('referral_status_eligible') }}</strong>
                {% else %}
                  <strong>{{ t('referral_status_pending') }}</strong>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted" style="margin-top:10px;">{{ t('referral_none_yet') }}</div>
      {% endif %}
    </div>

    <form method="POST" action="/profile" enctype="multipart/form-data" class="card-pro" style="margin-top:14px; padding:14px;">
      <label class="muted" style="display:block; font-size:0.95em;">{{ t('label_full_name') }}</label>
      <input name="full_name" type="text" value="{{ full_name }}" class="input" />

      <label class="muted" style="display:block; font-size:0.95em; margin-top:10px;">{{ t('label_mobile_read_only') }}</label>
      <input type="text" value="{{ mobile }}" readonly class="input" style="margin:0;" />

      <label class="muted" style="display:block; font-size:0.95em; margin-top:10px;">{{ t('label_upi_id') }}</label>
      <input name="upi_id" type="text" value="{{ upi_id }}" placeholder="example@upi" class="input" />

      <div style="margin-top:14px; padding-top:14px; border-top:1px solid #eef3f5;">
        <div class="sectionTitle" style="margin-top:0;">{{ t('documents_title') }}</div>
        <div class="muted" style="font-size:0.95em; margin-top:6px; line-height:1.4;">
          {{ t('documents_help') }}
        </div>

        <div class="card-pro" style="margin-top:12px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:bold;">Aadhaar</div>
            {% if aadhaar_doc %}
              <a href="/profile/doc/aadhaar" class="btn btn-secondary btn-sm" style="width:auto;">{{ t('download') }}</a>
            {% else %}
              <span class="muted" style="font-size:0.9em;">{{ t('not_uploaded') }}</span>
            {% endif %}
          </div>
          <input type="file" name="aadhaar_file" accept=".pdf,image/*" style="width:100%; margin-top:10px;" />
        </div>

        <div class="card-pro" style="margin-top:12px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:bold;">PAN</div>
            {% if pan_doc %}
              <a href="/profile/doc/pan" class="btn btn-secondary btn-sm" style="width:auto;">{{ t('download') }}</a>
            {% else %}
              <span class="muted" style="font-size:0.9em;">{{ t('not_uploaded') }}</span>
            {% endif %}
          </div>
          <input type="file" name="pan_file" accept=".pdf,image/*" style="width:100%; margin-top:10px;" />
        </div>

        <div class="card-pro" style="margin-top:12px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:bold;">Passport</div>
            {% if passport_doc %}
              <a href="/profile/doc/passport" class="btn btn-secondary btn-sm" style="width:auto;">{{ t('download') }}</a>
            {% else %}
              <span class="muted" style="font-size:0.9em;">{{ t('not_uploaded') }}</span>
            {% endif %}
          </div>
          <input type="file" name="passport_file" accept=".pdf,image/*" style="width:100%; margin-top:10px;" />
        </div>
      </div>

      <button type="submit" class="btn" style="margin-top:12px;">{{ t('save') }}</button>
    </form>

    <div class="card-pro" id="early-payout" style="margin-top:14px; padding:14px;">
      <div class="sectionTitle" style="margin-top:0;">{{ t('early_payout_title') }}</div>
      <div class="muted" style="margin-top:6px; line-height:1.45;">
        {{ t('early_payout_intro') }}
      </div>

      <div class="notice" style="margin-top:12px;">
        <div style="font-weight:800;">{{ t('benefit_deposit_title') }}</div>
        <div class="muted" style="margin-top:6px; line-height:1.45;">{{ t('benefit_deposit_body') }}</div>
        <div class="muted" style="margin-top:6px; line-height:1.45;">{{ t('benefit_deposit_return_body') }}</div>
        <div class="muted" style="margin-top:6px; line-height:1.45;">{{ t('info_deposit_label') }}</div>
      </div>

      {% if early_payout_groups and early_payout_groups|length > 0 %}
        <div style="margin-top:12px;">
          {% for g in early_payout_groups %}
            <div class="card-pro" style="padding:12px; margin-top:10px;">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                <div>
                  <div style="font-weight:800;">{{ g.group_name }}</div>
                  <div class="muted" style="font-size:0.95em;">{{ t('monthly_amount_label') }} ₹{{ g.monthly_amount }}</div>
                </div>
                <div class="muted" style="font-size:0.95em; text-align:right;">
                  {{ t('deposit_label') }} <strong>₹{{ g.deposit_amount }}</strong>
                </div>
              </div>

              {% if g.eligible %}
                <div class="muted" style="margin-top:8px;">{{ t('eligible_for_early_payout') }}</div>
                <form method="POST" action="/early-payout/request" style="margin-top:10px;">
                  <input type="hidden" name="group_id" value="{{ g.group_id }}" />
                  <input class="input" name="reason" placeholder="{{ t('placeholder_reason_optional') }}" style="margin:0;" />
                  <button type="submit" class="btn" style="margin-top:10px; width:100%;">{{ t('btn_request_early_payout') }}</button>
                </form>
              {% else %}
                <div class="muted" style="margin-top:8px;">{{ t('not_eligible_prefix') }} {{ g.reason }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted" style="margin-top:10px;">{{ t('join_group_for_early_payout') }}</div>
      {% endif %}

      <div class="sectionTitle" style="margin-top:14px;">{{ t('your_requests_title') }}</div>
      {% if early_payout_requests and early_payout_requests|length > 0 %}
        {% for r in early_payout_requests %}
          <div class="card-pro" style="padding:12px; margin-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
              <div>
                <div style="font-weight:800;">{{ r.group_name or ('Group #' ~ r.group_id) }}</div>
                <div class="muted" style="font-size:0.95em;">{{ t('created_label') }} {{ r.created_at }}</div>
              </div>
              <div class="muted" style="font-size:0.95em; text-align:right;">
                {{ t('status_label_short') }} <strong>{{ r.status }}</strong><br/>
                {{ t('deposit_status_label') }} <strong>{{ r.deposit_status }}</strong>
              </div>
            </div>
            <div class="muted" style="margin-top:8px;">{{ t('deposit_amount_label') }} ₹{{ r.deposit_amount }}</div>

            {% if company_upi_id %}
              <div class="muted" style="margin-top:6px; line-height:1.4;">
                {{ t('deposit_pay_instruction', upi=company_upi_id) | safe }}
              </div>
            {% else %}
              <div class="muted" style="margin-top:6px;">{{ t('deposit_upi_not_set') }}</div>
            {% endif %}

            {% if r.deposit_status != 'verified' %}
              <form method="POST" action="/early-payout/deposit" style="margin-top:10px;">
                <input type="hidden" name="request_id" value="{{ r.id }}" />
                <input class="input" name="utr" value="{{ r.utr }}" placeholder="{{ t('placeholder_utr_reference') }}" style="margin:0;" />
                <button type="submit" class="btn btn-secondary" style="margin-top:10px; width:100%;">{{ t('submit_deposit_utr') }}</button>
              </form>
            {% else %}
              <div class="muted" style="margin-top:8px;">{{ t('deposit_verified_under_review') }}</div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="muted" style="margin-top:10px;">{{ t('no_early_payout_requests') }}</div>
      {% endif %}
    </div>

    <div class="card-pro" style="margin-top:14px; padding:14px;">
      <div class="sectionTitle" style="margin-top:0;">{{ t('support_title') }}</div>
      <div class="muted" style="margin-top:6px;">{{ t('support_body') }}</div>
      <a href="/chat" class="btn btn-secondary" style="display:inline-block; margin-top:10px; width:auto;">{{ t('open_chat') }}</a>
    </div>

    <a href="/logout" class="btn" style="display:block; margin-top:14px;">{{ t('logout') }}</a>
    </div>
  </div>

  <script>
  function shareReferral() {
    const code = "{{ referral_code or '' }}";
    const text = "{{ t('referral_card_body') }}\n\n{{ t('referral_your_code') }} " + code;

    if (navigator.share) {
      navigator.share({
        title: "D-CONT",
        text,
      }).catch(() => {});
      return;
    }

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(code).then(() => {
        alert("Copied referral code: " + code);
      }).catch(() => {
        alert(code);
      });
      return;
    }

    alert(code);
  }
  </script>

</body>
</html>
