<!DOCTYPE html>
<html>
<head>
  <title>Profile - D-cont</title>
  <meta name="theme-color" content="#05060A">
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css', v=asset_version) }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json', v=asset_version) }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png', v=asset_version) }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png', v=asset_version) }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png', v=asset_version) }}">
</head>
<body class="app-body">
  {% include '_tab_nav.html' %}

  <div class="container">
    <div class="card">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="notice" style="margin-bottom:12px; padding:10px 12px;">
          {{ messages[0] }}
        </div>
      {% endif %}
    {% endwith %}

    <h2 style="margin:0;">Profile</h2>

    <div class="card-pro" style="margin-top:12px; padding:14px;">
      <div class="muted" style="font-size:0.95em;">App Fee Paid</div>
      <div style="font-size:18px; font-weight:bold;">{{ 'Yes' if app_fee_paid else 'No' }}</div>
    </div>

    <div class="card-pro" style="margin-top:12px; padding:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <div class="muted" style="font-size:0.95em;">Trust Score</div>
          <div style="font-size:18px; font-weight:bold;">{{ trust_score }} • {{ trust_score|trust_band }}</div>
        </div>
        <span class="{{ trust_score|trust_badge_class }}">{{ trust_score|trust_band }}</span>
      </div>
      <div class="muted" style="font-size:0.95em; margin-top:6px;">Tip: pay on time to increase your score.</div>
    </div>

    <form method="POST" action="/profile" enctype="multipart/form-data" class="card-pro" style="margin-top:14px; padding:14px;">
      <label class="muted" style="display:block; font-size:0.95em;">Full Name</label>
      <input name="full_name" type="text" value="{{ full_name }}" class="input" />

      <label class="muted" style="display:block; font-size:0.95em; margin-top:10px;">Mobile (read-only)</label>
      <input type="text" value="{{ mobile }}" readonly class="input" style="margin:0;" />

      <label class="muted" style="display:block; font-size:0.95em; margin-top:10px;">UPI ID</label>
      <input name="upi_id" type="text" value="{{ upi_id }}" placeholder="example@upi" class="input" />

      <div style="margin-top:14px; padding-top:14px; border-top:1px solid #eef3f5;">
        <div class="sectionTitle" style="margin-top:0;">Important documents</div>
        <div class="muted" style="font-size:0.95em; margin-top:6px; line-height:1.4;">
          Upload PDF/JPG/PNG/WEBP. Your documents are stored privately and can only be downloaded when you are logged in.
        </div>

        <div class="card-pro" style="margin-top:12px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:bold;">Aadhaar</div>
            {% if aadhaar_doc %}
              <a href="/profile/doc/aadhaar" style="color:#2D9CDB; text-decoration:none;">Download</a>
            {% else %}
              <span class="muted" style="font-size:0.9em;">Not uploaded</span>
            {% endif %}
          </div>
          <input type="file" name="aadhaar_file" accept=".pdf,image/*" style="width:100%; margin-top:10px;" />
        </div>

        <div class="card-pro" style="margin-top:12px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:bold;">PAN</div>
            {% if pan_doc %}
              <a href="/profile/doc/pan" style="color:#2D9CDB; text-decoration:none;">Download</a>
            {% else %}
              <span class="muted" style="font-size:0.9em;">Not uploaded</span>
            {% endif %}
          </div>
          <input type="file" name="pan_file" accept=".pdf,image/*" style="width:100%; margin-top:10px;" />
        </div>

        <div class="card-pro" style="margin-top:12px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:bold;">Passport</div>
            {% if passport_doc %}
              <a href="/profile/doc/passport" style="color:#2D9CDB; text-decoration:none;">Download</a>
            {% else %}
              <span class="muted" style="font-size:0.9em;">Not uploaded</span>
            {% endif %}
          </div>
          <input type="file" name="passport_file" accept=".pdf,image/*" style="width:100%; margin-top:10px;" />
        </div>
      </div>

      <button type="submit" style="margin-top:12px; width:100%; background:#2D9CDB; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;">Save</button>
    </form>

    <div class="card-pro" id="early-payout" style="margin-top:14px; padding:14px;">
      <div class="sectionTitle" style="margin-top:0;">Early Payout</div>
      <div class="muted" style="margin-top:6px; line-height:1.45;">
        Early payout is a <strong>schedule/priority request</strong> (not a loan). If eligible, you can request to receive earlier than your current turn.
        A <strong>security deposit</strong> may be required and is verified by the owner.
      </div>

      {% if early_payout_groups and early_payout_groups|length > 0 %}
        <div style="margin-top:12px;">
          {% for g in early_payout_groups %}
            <div class="card-pro" style="padding:12px; margin-top:10px;">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                <div>
                  <div style="font-weight:800;">{{ g.group_name }}</div>
                  <div class="muted" style="font-size:0.95em;">Monthly amount: ₹{{ g.monthly_amount }}</div>
                </div>
                <div class="muted" style="font-size:0.95em; text-align:right;">
                  Deposit: <strong>₹{{ g.deposit_amount }}</strong>
                </div>
              </div>

              {% if g.eligible %}
                <div class="muted" style="margin-top:8px;">Eligible for early payout.</div>
                <form method="POST" action="/early-payout/request" style="margin-top:10px;">
                  <input type="hidden" name="group_id" value="{{ g.group_id }}" />
                  <input class="input" name="reason" placeholder="Reason (optional)" style="margin:0;" />
                  <button type="submit" class="btn" style="margin-top:10px; width:100%;">Request Early Payout</button>
                </form>
              {% else %}
                <div class="muted" style="margin-top:8px;">Not eligible: {{ g.reason }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted" style="margin-top:10px;">Join a group to request early payout.</div>
      {% endif %}

      <div class="sectionTitle" style="margin-top:14px;">Your requests</div>
      {% if early_payout_requests and early_payout_requests|length > 0 %}
        {% for r in early_payout_requests %}
          <div class="card-pro" style="padding:12px; margin-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
              <div>
                <div style="font-weight:800;">{{ r.group_name or ('Group #' ~ r.group_id) }}</div>
                <div class="muted" style="font-size:0.95em;">Created: {{ r.created_at }}</div>
              </div>
              <div class="muted" style="font-size:0.95em; text-align:right;">
                Status: <strong>{{ r.status }}</strong><br/>
                Deposit: <strong>{{ r.deposit_status }}</strong>
              </div>
            </div>
            <div class="muted" style="margin-top:8px;">Deposit amount: ₹{{ r.deposit_amount }}</div>

            {% if company_upi_id %}
              <div class="muted" style="margin-top:6px; line-height:1.4;">
                Pay the security deposit to <strong>{{ company_upi_id }}</strong>, then submit the UTR/reference.
              </div>
            {% else %}
              <div class="muted" style="margin-top:6px;">Security deposit payment UPI is not set. Please contact support.</div>
            {% endif %}

            {% if r.deposit_status != 'verified' %}
              <form method="POST" action="/early-payout/deposit" style="margin-top:10px;">
                <input type="hidden" name="request_id" value="{{ r.id }}" />
                <input class="input" name="utr" value="{{ r.utr }}" placeholder="Enter UTR/reference" style="margin:0;" />
                <button type="submit" class="btn btn-secondary" style="margin-top:10px; width:100%;">Submit Deposit UTR</button>
              </form>
            {% else %}
              <div class="muted" style="margin-top:8px;">Deposit verified. Your request is under review.</div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="muted" style="margin-top:10px;">No early payout requests yet.</div>
      {% endif %}
    </div>

    <div class="card-pro" style="margin-top:14px; padding:14px;">
      <div class="sectionTitle" style="margin-top:0;">Support</div>
      <div class="muted" style="margin-top:6px;">Have a question? Chat with the D-CONT Bot.</div>
      <a href="/chat" class="btn btn-secondary" style="display:inline-block; margin-top:10px; width:auto;">Open Chat</a>
    </div>

    <a href="/logout" class="btn" style="display:block; margin-top:14px;">Logout</a>
    </div>
  </div>

</body>
</html>
